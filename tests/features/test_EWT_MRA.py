from unittest import TestCase
from damage_identification.features.EWT_MRA import MultiResolutionAnalysis
from numpy import testing
import pywt

class TestMultiResolutionAnalysis(TestCase):
    def test_decomposition(self):
        mra = MultiResolutionAnalysis('db3', 'symmetric', 8, 6)
        mra.load('data/comp0.tradb', 11145)
        mra.data_handler()
        print(mra.decomposer())



    def test_short_signal_decomposition(self):
        mra = MultiResolutionAnalysis('db1', 'symmetric', 4, 2)
        mra.load_manual([1,2,3,4,-1,-2,-3,-4,1,2,3,4,-1,-2,-3,-4])
        mra.data_handler()
        mra.decomposer()

    def test_WPT(self):
        mra = MultiResolutionAnalysis('db3', 'symmetric', 2, 6)
        mra.load('data/comp0.tradb', 100)
        mra.data_handler()
        test_decomposition, total_energy = mra.decomposer()
        known_decomposition = [[0.00032041393609684454, 4.4883386232744707e-07, 1.6801564865231022e-07, 2.492706406126372e-05, 0.00011280831808498628, 0.00013646945427275427, 9.218072694548565e-05, 0.00010309594690903596], [3.640452018960517e-05, 1.5896984392252792e-05, 0.00012120389678900997, 0.00036576299735107363, 0.016733793910816277, 0.018825858668652693, 0.010194132740314643, 0.0013474724471751972], [3.3569765207758035e-05, 2.6649317516936732e-05, 6.043519678127754e-06, 0.004146857296327186, 0.0015048749510609618, 0.0010573462611155931, 0.0006708572193123902, 0.00012507541934995826], [0.00015754533417819188, 4.995053332526589e-05, 2.0134858190510982e-05, 0.0015460138371016865, 0.02633406387923318, 0.03399977825477628, 0.020487376249562383, 0.0026711424534067306], [1.3781377072474094e-05, 0.0006175296990527315, 0.0004266408072428733, 0.053886537504780216, 0.11775874303934024, 0.00674004121298464, 0.002693297347933595, 0.005050328467611415], [4.4139619464004424e-05, 2.782196232293263e-05, 1.690640540900506e-05, 0.01864631030796612, 0.013180686211814448, 0.0035428663940259403, 0.0016564788162027994, 8.650943466867807e-05], [4.6904402457493965e-06, 2.6569481145261236e-05, 7.154639077411106e-06, 0.00046875986245788204, 0.0007796923251409916, 0.00013571164453713815, 6.98264106044321e-05, 8.17681640930895e-05], [3.6967470785418266e-05, 1.0226657360858157e-05, 1.1775836121737703e-05, 0.012371596915964336, 0.003192862519629834, 0.002856009185639322, 0.0015147428417469674, 7.302694825131035e-05], [6.061603695099212e-07, 5.775332180230157e-06, 2.699964941839942e-06, 2.7982628206687774e-05, 0.0002467515051313859, 0.00014929965270177615, 5.935668534513818e-05, 4.718651791726416e-05], [3.7163085421304886e-06, 8.771858520897929e-06, 6.725593481056547e-07, 0.0009472841839380921, 0.0002457865756483621, 4.8082178993251954e-05, 2.1173791448143346e-05, 2.1827791849967205e-05], [2.2823515212682733e-05, 6.159601626417796e-05, 1.1203955479908934e-05, 0.01200552659065417, 0.001525589063185577, 0.00041574264786578514, 6.455593162432114e-05, 3.571668816719092e-05], [3.407482583212522e-05, 4.4947698957956355e-05, 4.661381881625153e-06, 0.004288789069094727, 0.000932679167402619, 0.00010077606401323453, 5.668898490023469e-05, 2.2969522716253602e-05], [3.783100528228337e-05, 0.0006029867988132104, 0.00037536411358710743, 0.07741488664259893, 0.08529740474265181, 0.011504086859330732, 0.007417999540266814, 0.0037513565628494593], [1.0175805578132867e-05, 1.1608429863401844e-05, 0.000128605467460207, 0.09512248595831839, 0.02787354735368473, 0.00724847622865813, 0.003967478938154529, 0.000655890951356673], [3.630689811825031e-06, 0.00035103471522934614, 7.978818191529643e-06, 0.01280112995538497, 0.00282118921269364, 0.0002545232309814171, 0.00012298737326400146, 0.00041627905851961827], [0.00016741763036104903, 5.053572079711748e-05, 2.1466064983954616e-05, 0.05455138309737106, 0.010443968029657566, 0.0022267136698794618, 0.0014446875514495484, 6.595914946627662e-05], [2.0054245754504443e-07, 9.194509009607689e-07, 3.8299561234675654e-08, 9.630048493337153e-05, 1.28899707455572e-05, 1.6911185996225961e-06, 2.013488037173583e-06, 9.044056064899502e-07], [1.4019037084134425e-07, 1.188484545737041e-07, 7.785900256739864e-08, 0.00019301209991367488, 1.4916784109246621e-06, 2.3081182512164434e-06, 4.37325538682968e-07, 3.073862814514049e-07], [8.618852209830437e-06, 3.2446087447849414e-06, 3.2483915140626795e-07, 0.001681379695455462, 0.0002986823820615873, 4.399350614656846e-05, 5.439944962029146e-06, 9.88324365074563e-06], [6.333784282050984e-07, 2.4054028496237536e-07, 1.3310866101685343e-07, 0.00024790986847172443, 4.5040714166920374e-05, 9.384563542546321e-06, 1.9429779356118098e-06, 1.2642345516602592e-06], [1.203180966085271e-06, 1.9543022052110882e-05, 1.4852496312637536e-05, 0.01569080547743592, 0.003763983454839645, 0.00023171401668230907, 1.7998555327007584e-05, 0.0002155891772789969], [8.066119349658674e-06, 1.4221727595177477e-06, 5.141768058756146e-07, 0.009539021283148638, 0.0003945765504779321, 0.00010342866662994459, 0.00018964935353547757, 1.3466703514786943e-05], [8.918571089971536e-07, 3.2092689249699737e-06, 5.673474677079133e-07, 0.012012532981446552, 0.0002572472889771609, 1.0489958203515201e-05, 1.0493298599205011e-05, 5.1619559231395455e-06], [7.123770004385804e-07, 1.5214828108783199e-06, 5.878445859878396e-07, 0.0028412547419654093, 0.00013394864795292374, 4.303658867475804e-05, 2.168153459191648e-05, 8.645972984118205e-07], [4.1772273509682994e-08, 5.691542132748474e-06, 1.307347680920031e-06, 0.0012947848886545293, 0.0024062700951398733, 0.00025824981711844566, 1.4501838673903355e-05, 1.8964713353459192e-05], [4.4193537893030424e-07, 2.9687334874909806e-06, 2.53562431572125e-07, 0.0008976512890408678, 0.0009421528573578328, 1.1515932181472601e-05, 9.270433911305533e-06, 5.98582932446295e-06], [2.241216246752677e-06, 1.8045572541819843e-05, 2.06023106836298e-06, 0.007497678219341474, 0.0010275134192637091, 0.00017619035899409837, 8.834679530916529e-06, 2.2889138373016405e-05], [4.779170094278904e-06, 7.006119406241118e-07, 7.653123966384019e-07, 0.0008873888860621549, 0.0006084744909260301, 3.759809139952761e-05, 5.006638178955203e-06, 1.6059020172156053e-05], [1.6530444268336616e-06, 2.963892151727024e-05, 1.3713108903706862e-05, 0.01353405841845579, 0.001744349787817967, 0.0005645071402034149, 0.0002674913435733364, 0.00015884334440638846], [3.7607949112752554e-07, 1.9003771753288791e-06, 6.252045536926087e-06, 0.052928398628377955, 0.0034417117941508376, 0.00015024085875617844, 0.00016638921127241031, 6.492220152045646e-05], [6.238539256181671e-07, 7.474376264527312e-05, 5.0098788948690515e-06, 0.004560074507668003, 0.0012620493328584007, 0.00023051878511679176, 8.664629030991017e-05, 0.00012745771969245793], [1.1446614673105726e-05, 1.1551276795538238e-05, 1.1486568383824015e-06, 0.020528283422853795, 0.0010358035551947908, 0.00024858026184843544, 6.122134326949287e-05, 1.0211902309051458e-05], [1.2348284052848574e-09, 3.140954463396778e-09, 2.2102097840546914e-08, 1.0251349296436691e-07, 5.660041061365192e-08, 9.697298547361622e-09, 1.4083883341083199e-08, 2.69364248496444e-06], [5.944230626638076e-09, 1.927007642204458e-08, 2.6524724984872722e-08, 3.284894622273962e-07, 7.018377933130412e-09, 7.372974422173659e-08, 4.59261514265099e-09, 8.172196063853034e-07], [2.714667615205335e-08, 2.9065597470052084e-08, 3.70536026644814e-08, 8.150835779824971e-06, 3.9208852403770737e-07, 9.276588664580229e-08, 1.987620520234522e-08, 4.298776609391005e-08], [2.0856298757593098e-08, 2.769224324097006e-08, 3.414122245329732e-08, 3.894661574141071e-06, 1.346228983023675e-07, 7.737773944777604e-08, 8.744680913015092e-08, 6.409467148386155e-07], [4.053326786031458e-08, 4.6846740970490456e-07, 1.3905057217671574e-07, 9.230890274663733e-05, 7.640495319339944e-05, 6.272034875781804e-06, 3.648497444113623e-06, 3.054301161761049e-06], [6.010193513917559e-08, 6.937868971320177e-08, 6.218814682204831e-08, 6.087845675030493e-05, 1.0001147478258953e-05, 8.888680140966766e-06, 1.1048205385452723e-06, 1.8000033464858985e-07], [5.097324535281452e-09, 9.978045885887562e-08, 1.909472753874265e-08, 9.002523332375644e-06, 3.155579017300701e-07, 2.2948609250405783e-07, 7.565033578469305e-08, 2.3870992848751304e-07], [6.442335091911186e-08, 1.4547110304374123e-08, 4.076452104036859e-08, 1.2241781660130611e-05, 4.24172584477267e-06, 1.4014292972167872e-06, 5.098806582288728e-07, 2.446178773833447e-07], [4.808922734815508e-07, 3.78734029083862e-07, 1.7908043612045243e-07, 1.3828862317190849e-05, 6.548444193813456e-06, 4.063111209026081e-06, 1.7187875807178359e-06, 1.9035953031923149e-06], [2.733112358452336e-07, 5.090207441725371e-07, 2.544710588336517e-08, 4.344656251509444e-06, 3.3150175530203437e-06, 4.0230747289781394e-07, 1.8664439372249783e-07, 1.1761588170102951e-06], [4.0283383158080656e-07, 4.094968127865929e-07, 4.5349028302759017e-08, 0.0001077070798111161, 3.931172713127202e-05, 1.0339749566535583e-06, 9.846799602735391e-07, 3.7470011021717026e-07], [3.927633995451017e-07, 3.708915892041106e-07, 1.1655240875843446e-07, 1.3013464567701964e-05, 1.5638790102521652e-05, 9.538395938453203e-07, 7.214360636377127e-07, 3.6544595454723725e-07], [4.6204162158708226e-08, 5.870924033798744e-07, 3.1215158145363365e-07, 1.4374724201004109e-05, 0.00017669766654445498, 1.8928494229865254e-05, 3.618214419803908e-06, 4.764677853760715e-06], [4.58525390707345e-08, 7.518105093235888e-08, 2.3199468108353065e-07, 0.00020900460875563872, 1.9705170527916205e-05, 8.178524713836019e-06, 9.708980646617732e-06, 4.70128095344178e-06], [5.926800394615915e-07, 5.025281977462612e-07, 3.173359064078363e-08, 0.00023249646257007884, 5.7827906017544857e-05, 2.652900731608026e-06, 7.029846768783054e-07, 5.5288759558137766e-06], [7.3633529296424e-07, 2.374056594786001e-07, 1.6692359271852576e-07, 4.0988770046648484e-05, 2.013138856461137e-05, 2.644003303707419e-06, 2.4435642152541155e-06, 6.931534138726636e-07], [4.5864536521376286e-08, 1.2946502825965451e-06, 1.32931116312001e-07, 8.942058474911432e-05, 2.233621270070134e-06, 2.8630893945945354e-06, 9.97435787140102e-07, 3.933370477831529e-06], [1.398218713850685e-06, 4.492108264660495e-07, 5.96554889663134e-08, 1.8407946274479024e-05, 7.718245781122008e-06, 1.4013507323879644e-06, 5.096645196690399e-07, 1.3810444193208248e-06], [2.864545278232031e-06, 2.874699900803941e-06, 2.3212465898651688e-07, 0.0027131368955018824, 5.4945207363838994e-05, 2.9846465426741742e-05, 5.526626193887255e-06, 1.8639747691144142e-06], [8.504696416904529e-07, 2.601535896642677e-07, 1.05027590836192e-07, 0.00048347312622182975, 6.908324642208946e-06, 2.7716341733475953e-06, 1.082662661282872e-07, 8.909658650907914e-07], [1.3838741346344473e-07, 5.655051017296448e-07, 1.7747370796593667e-07, 0.00041837785856455983, 0.000168668055831506, 2.5678410441095066e-05, 1.065749272688472e-05, 3.7392099523855895e-06], [2.3558098853425434e-07, 2.0932725613819822e-07, 4.591982784829955e-08, 0.001210095616920784, 2.9111429787771375e-05, 6.1703828461533825e-06, 1.6915151006039588e-06, 7.463648220547473e-07], [1.793605940053827e-06, 5.677218256640115e-07, 7.48040210904727e-08, 0.0007554561132961895, 3.932563676549376e-05, 1.2164745266932867e-05, 3.2413928736255697e-06, 1.6982130425779375e-06], [2.2402029714753626e-06, 4.498657558112034e-07, 1.6702877953745005e-08, 6.800126826474682e-05, 2.358551288578878e-05, 6.843027842818633e-06, 8.80582878815014e-07, 2.1230745598551543e-07], [2.877194099828286e-07, 1.6166645181365965e-07, 5.8932666005166254e-08, 3.330961601868579e-05, 6.409879968942668e-05, 4.631867445032994e-06, 5.418908750853055e-07, 1.567140437572752e-07], [1.6190853572959574e-08, 1.3941729817435065e-07, 1.3572254335935316e-08, 4.258204176170846e-05, 2.8435518790887922e-05, 5.638352720650591e-07, 3.1427508318797174e-07, 1.1541296811144451e-07], [5.1356012262200337e-08, 3.1144737569618914e-07, 8.017189631695113e-08, 0.0006873829499869169, 2.885204161742387e-05, 7.444788469862366e-06, 8.378386536294652e-07, 3.8434456439537015e-07], [2.3655906926192515e-07, 1.381747614751013e-07, 5.73861291254477e-08, 5.985917780029811e-05, 8.699058563381405e-06, 8.457253073068246e-07, 3.6479416296362564e-07, 6.173948334162578e-07], [8.686282223708533e-08, 3.7347250706875854e-07, 7.174506283794306e-08, 0.0037269910877904128, 0.0002912211810214701, 5.145802663474251e-05, 1.733436908110138e-06, 7.559779545514389e-07], [1.0796085141947741e-06, 2.0130191050068623e-07, 6.245930076431419e-08, 0.005024363992061043, 0.00013737552710872683, 4.528831355054608e-05, 1.3980794708137902e-06, 9.615064621441042e-07], [7.019807814450655e-07, 1.6207729704424184e-06, 4.020213776261462e-08, 0.0008812038755698175, 0.00011911854043454048, 1.1847056036501121e-05, 3.572269094346623e-06, 5.439629759438805e-06], [1.5912080524639378e-06, 7.004759005646003e-07, 5.778216006093473e-08, 0.0009676856506400934, 3.6116281481241044e-05, 1.0295131580725696e-05, 8.963580788317657e-07, 3.895938019337318e-07]]
        self.assertAlmostEqual(total_energy, 1, 2)
        testing.assert_array_equal(test_decomposition, known_decomposition)




